\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}

\title{Marlin Diagram}
\date{July 2020}

\usepackage[x11names]{xcolor}
\usepackage[c4paper, margin=0.3in]{geometry}
\usepackage{tikz}

\newenvironment{rcases}
  {\left.\begin{aligned}}
  {\end{aligned}\right\rbrace}

\begin{document}

\newcommand{\cm}[1]{\ensuremath{\mathsf{cm}_{#1}}}
\newcommand{\vcm}[1]{\ensuremath{\mathsf{vcm}_{#1}}}
\newcommand{\s}{\ensuremath{\hat{s}}}
\newcommand{\w}{\ensuremath{\hat{w}}}
\newcommand{\z}{\ensuremath{\hat{z}}}
\newcommand{\za}{\ensuremath{\hat{z}_A}}
\newcommand{\zb}{\ensuremath{\hat{z}_B}}
\newcommand{\zc}{\ensuremath{\hat{z}_C
}}
\newcommand{\zm}{\ensuremath{\hat{z}_M}}

\newcommand{\val}{\ensuremath{\mathsf{val}}}
\newcommand{\row}{\ensuremath{\mathsf{row}}}
\newcommand{\col}{\ensuremath{\mathsf{col}}}
\newcommand{\rowcol}{\ensuremath{\mathsf{rowcol}}}

\newcommand{\hval}{\ensuremath{\hat{\val}}}
\newcommand{\hrow}{\ensuremath{\hat{\row}}}
\newcommand{\hcol}{\ensuremath{\hat{\col}}}
\newcommand{\hrowcol}{\ensuremath{\hat{\rowcol}}}

\newcommand{\bb}{\ensuremath{\mathsf{b}}}
\newcommand{\denom}{\ensuremath{\mathsf{denom}}}

\newcommand{\sumcheckinner}{\mathsf{sumcheck}
_{\mathsf{inner}}}
\newcommand{\sumcheckouter}{\mathsf{sumcheck}_{\mathsf{outer}}}

\newcommand{\Prover}{\mathcal{P}}
\newcommand{\Verifier}{\mathcal{V}}

\newcommand{\F}{\mathbb{F}}

\newcommand{\DomainA}{H}
\newcommand{\DomainB}{K}

\newcommand{\vPoly}[1]{\ensuremath{v_{#1}}}


\begin{figure}[H]
\centering
\makebox[\textwidth][c]{
  \centering
\begin{tikzpicture}[scale=0.9, every node/.style={scale=0.9}]

\tikzstyle{lalign} = [minimum width=3cm,align=left,anchor=west]
\tikzstyle{ralign} = [minimum width=3cm,align=right,anchor=east]

\node[lalign] (prover) at (-2,27.8) {%
$\Prover(\F, \DomainA, \DomainB, A, B, C, x, w)$
};

\node[ralign] (verifier) at (15.2,27.8) {%
$\Verifier^{\hrow_{\{A^*, B^*, C^*\}}, \hcol_{\{A^*, B^*, C^*\}}, \hval_{\{A^*, B^*, C^*\}}}(\F, \DomainA, \DomainB, x)$
};

\draw [line width=1.0pt] (-2,27.3) -- (15,27.3);

\node[lalign] (prover1) at (-2,26.1) {%
$z := (x, w), \za := Az, \zb := Bz$ \\
sample $\w(X) \in \F^{<|w|+\bb}[X]$ and $\za(X), \zb(X) \in \F^{<|\DomainA|+\bb}[X]$ \\
sample mask poly $\s(X) \in \F^{<3|\DomainA|+2\bb-2}[X]$ such that $\sum_{\kappa \in \DomainA}\s(\kappa) = 0$
};

\draw [->] (-1,24.8) -- node[midway,fill=white] {
commitments $\cm{\w}, \cm{\za}, \cm{\zb}, \cm{\s}$
} (13,24.8);

\node[ralign] (verifier1) at (15.4,24.0) {%
$\eta_A, \eta_B, \eta_C \gets \F$ \\
$\alpha \gets \F \setminus \DomainA$
};

\draw [->] (13,23.3) -- node[midway,fill=white] {$\eta_A, \eta_B, \eta_C, \alpha \in \F$} (-1,23.3);

\node[lalign] (prover1_5) at (-2,22.5) {%
compute $t(X) := \sum_M \eta_M r_M(\alpha, X)$
};

\draw (-2.2,22.0) rectangle (15.2,5.4);

\node (sc1label) at (6.5,21.7) {%
\textbf{sumcheck for} $\s(X) + r(\alpha, X) \left(\sum_M \eta_M \zm(X)\right) - t(X)\z(X)$ \textbf{ over } $\DomainA$
};

\node[lalign] (prover1) at (-2,20.7) {%
let $\zc(X) := \za(X) \cdot \zb(X)$ \\
find $g_1(X)$ and $h_1(X)$ such that \\
$s(X)+r(\alpha, X)(\sum_M \eta_M \zm(X)) - t(X)\z(X) = h_1(X)\vPoly{\DomainA}(X) + Xg_1(X)$ \hspace{0.3cm} $(*)$
};

\draw [->] (2,19.5) -- node[midway,fill=white] {commitments $\cm{t}, \cm{g_1}, \cm{h_1}$} (10,19.5);

\node[ralign] (verifier2) at (15.4,19.3) {%
$\beta \gets \F \setminus \DomainA$
};

\draw [->] (8,18.8) -- node[midway,fill=white] {$\beta \in \F$} (4,18.8);

\draw (-0.85,18.2) rectangle (13.85,8.4);

\node (sc2label) at (6.5,17.6) {%
\textbf{sumcheck for } $\sum\limits_{M \in \{A, B, C\}} \eta_M \frac{\vPoly{\DomainA}(\beta) \vPoly{\DomainA}(\alpha)\hval_{M^*}(X)}{\color{purple}(\beta-\hrow_{M^*}(X))(\alpha-\hcol_{M^*}(X))} $ \textbf{ over } $\DomainB$
};

\node[align=center] (mid1) at (6.5, 16.3) {%
$\begin{aligned} 
\text{for } M \in \{A, B, C\} \text{, let } {\color{purple} M_\denom(X)} &:= (\beta - \hrow_{M^*}(X)) (\alpha - \hcol_{M^*}(X)) \\
&= {\color{gray}\alpha\beta} - {\color{gray}\alpha}\hrow_{M^*}(X) - {\color{gray}\beta}\hcol_{M^*}(X) + \hrowcol_{M^*}(X)
\end{aligned}$
};

\node[align=center] (mid2) at (6.5, 15.0) {%
let ${\color{orange} a(X)} := \sum\limits_{M \in \{A, B, C\}} {\color{gray} \eta_M \vPoly{\DomainA}(\beta) \vPoly{\DomainA}(\alpha)} \hval_{M^*}(X) \prod_{N \neq M} {\color{purple} N_\denom(X)}$
};

\node[align=center] (mid2) at (6.5, 14.1) {%
let ${\color{Green4} b(X)} := \sum\limits_{M \in \{A, B, C\}} {\color{purple} M_\denom(X)}$
};

\node[lalign] (prover2) at (-0.75,13.2) {%
find $g_2(X)$ and $h_2(X)$ s.t. \\
$h_2(X)\vPoly{\DomainB}(X) = {\color{orange} a(X)} - {\color{Green4} b(X)} (Xg_2(X)+t(\beta)/|\DomainB|)$ \hspace{0.3cm} $(**)$
};

\draw [->] (2,12.2) -- node[midway,fill=white] {commitments $\cm{g_2}, \cm{h_2}$} (10,12.2);

\draw [->] (8,11.5) -- node[midway,fill=white] {$\gamma$} (4,11.5);

\node[ralign] (verifier3) at (14.5, 11.8) {%
$\gamma \gets \F$
};

\draw[dashed] (1.5,11.0) rectangle (11.5,8.8);

\node[align=center] (mid3) at (6.5, 9.7) {%
To verify $(**)$, $\Verifier$ will need to check the following: \\[10pt]
$ \underbrace{{\color{orange} a({\color{black} \gamma})} - {\color{Green4} b({\color{black} \gamma})} {\color{gray} (\gamma g_2(\gamma) + t(\beta) / |\DomainB|) - \vPoly{\DomainB}(\gamma)} h_2(\gamma)}_{\sumcheckinner(\gamma)} = 0 $
};

\draw[dashed] (-1.5,8.0) rectangle (14.5,5.8);

\node[align=center] (mid4) at (6.5, 6.9) {%
To verify $(*)$, $\Verifier$ will need to check the following: \\[10pt]
$ \underbrace{s(\beta) + {\color{gray} r(\alpha, \beta)} ({\color{gray} \eta_A} \za(\beta) + {\color{gray} \eta_C\zb(\beta)} \za(\beta) + {\color{gray} \eta_B\zb(\beta)}) - {\color{gray} t(\beta) \vPoly{X}(\beta)} \w(\beta) - {\color{gray} \vPoly{\DomainA}(\beta)} h_1(\beta) - {\color{gray} \beta g_1(\beta)}}_{\sumcheckouter(\beta)} = 0 $
};

\draw [->] (-2,4.5) -- node[midway,fill=white] {
evals $g_2(\gamma), A_\denom(\gamma), B_\denom(\gamma), C_\denom(\gamma), \sumcheckinner(\gamma), g_1(\beta), \zb(\beta), t(\beta), \sumcheckouter(\beta)$
} (15,4.5);

\node[ralign] (verifier4) at (16,3.4) {%
use index commitments $\hrow, \hcol, \hrowcol$ to \\
construct virtual commitments $\vcm{\{A_\denom, B_\denom, C_\denom\}}$
};

\node[ralign] (verifier5) at (16,1.9) {%
use index commitments $\hval$, commitments $\vcm{A_\denom}$, \\
$\vcm{B_\denom}, \vcm{C_\denom}, \cm{h_2}$, and {\color{gray} evaluations $g_2(\gamma),t(\beta)$} \\
to construct virtual commitment $\vcm{\sumcheckinner}$
};

\node[ralign] (verifier6) at (16,0.2) {%
use commitments $\cm{\s}, \cm{\za}, \cm{\w}, \cm{h_1}$ \\
and {\color{gray} evaluations $\zb(\beta), t(\beta), g_1(\beta)$} \\
to construct virtual commitment $\vcm{\sumcheckouter}$
};

\node[ralign] (verifier7) at (16,-1.0) {%
$\xi_1, \dots, \xi_5 \gets \F$
};

\draw [->] (15,-1.5) -- node[midway,fill=white] {$\xi_1, \dots, \xi_5$} (-2,-1.5);

\node[lalign] (prover6) at (-3,-2.5) {%
use $\mathsf{PC}.\mathsf{Prove}$ with randomness $\xi_1, \dots, \xi_5$ to construct \\
batch open proof $\pi$ for the five polynomials \\
evaluated at $\gamma$ and the four evaluated at $\beta$
};

\draw [->] (-2,-3.5) -- node[midway,fill=white] {$\pi$} (15,-3.5);

\node[ralign] (verifier8) at (16,-4.5) {%
verify $\pi$ with $\mathsf{PC}.\mathsf{Verify}$, using randomness $\xi_1, \dots, \xi_5$ \\
and commitments $\cm{g_2}, \vcm{A_\denom}, \vcm{B_\denom}, \vcm{C_\denom},$ \\
$\vcm{\sumcheckinner}, \cm{g_1}, \cm{\zb}, \cm{t}, \vcm{\sumcheckouter}$
};

\node[ralign] (verifier9) at (16,-5.8) {%
check that $\sumcheckouter(\beta) = \sumcheckinner(\gamma) = 0$
};


\end{tikzpicture}
}
\end{figure}


\end{document}
